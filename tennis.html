<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">
    </head>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <script>
        var canvas;
        var canvasContext;
        var ballX = 75, ballY = 75;
        var ballSpeedX = 10;
        var ballSpeedY = 10;

        var paddle1Y = 250; // Left paddle's Y position.
        var paddle2Y = 250; // Right paddle's Y position.

        const PADDLE_HEIGHT = 100; // Constant for Paddle's height.
        const PADDLE_THICKNESS = 10;
        const PADDLE_COLOR = '#FFFFFF';

        var paddle1Score = 0;
        var paddle2Score = 0;

        // window.onload runs automatically when the page finishes loading.
        window.onload = function()
        {            
            // Save the canvas for dimensions and its 2d context for drawing to it.
            canvas = document.getElementById('gameCanvas');
            canvasContext = canvas.getContext('2d');

            var framesPerSecond = 30;

            // Calls function every N number of milliseconds.
            setInterval(function() // Anonymous function for calling multiple functions for each interval.
                {
                    moveEverything();
                    drawEverything();
                }, 1000/framesPerSecond); // 1000 equals one sec. Divide by frames to get fps.

            // Each time the mouse is moved the coordinates are calculated and the paddle is moved from center
            // where the mouse is at vertically.
            canvas.addEventListener('mousemove', 
                function(evt)
                {
                    var mousePos = calculateMousePos(evt);
                    paddle1Y = mousePos.y - (PADDLE_HEIGHT/2); // Minus half height, to center it.

                });
        };

        function calculateMousePos(evt)
        {
            var rect = canvas.getBoundingClientRect(), root = document.documentElement;

            // Account for the margins, canvas position on page, scroll amount, etc...
            var mouseX = evt.clientX - rect.left - root.scrollLeft;
            var mouseY = evt.clientY - rect.top - root.scrollTop;

            return {
                x: mouseX,
                y: mouseY
            };
        };

        function  ballReset()
        {
            ballX = canvas.width / 2;
            ballY = canvas.height / 2;

            ballSpeedX *= -1; // Flip horizontal direction so that it doesn't get stuck going left.
        };

        function didBallCollideWithPaddle1()
        {
            if (ballY > paddle1Y && ballY < paddle1Y + PADDLE_HEIGHT)
            {
                return true;
            }

            return false;
        };

        function didBallCollideWithPaddle2()
        {
            if (ballY > paddle2Y && ballY < paddle2Y + PADDLE_HEIGHT)
            {
                return true;
            }

            return false;
        };

        function moveEverything()
        {
            // Ball moved past left edge.
            if (ballX < 0)
            {
                if (didBallCollideWithPaddle1())
                {
                    ballSpeedX *= -1; // Reverse ball's horizontal direction.

                    var deltaY = ballY-(paddle1Y+PADDLE_HEIGHT/2);
                    ballSpeedY = deltaY * 0.35;
                    console.log(ballSpeedY);
                }
                else
                {
                    paddle2Score ++;
                    ballReset();
                }
            }

            // Ball moved past right edge.
            if (ballX > canvas.width)
            {
                if (didBallCollideWithPaddle2())
                {
                    ballSpeedX *= -1;
                }
                else
                {
                    paddle1Score ++;
                    ballReset();
                }
            }

            if (ballY > canvas.height || ballY < 0)
            {
                ballSpeedY *= -1;
            }

            ballX += ballSpeedX;
            ballY += ballSpeedY;
        };

        function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor)
        {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight);
        };

        function colorCircle(centerX, centerY, radius, fillColor)
        {
            canvasContext.fillStyle = fillColor;
            canvasContext.beginPath(); // Tells browser that this is a new, separate shape.
            // x, y (from center), radius, start, and end angles. True means draw counterclockwise.
            canvasContext.arc(centerX, centerY, radius, 0, Math.PI*2, true); 
            canvasContext.fill(); // color in shape formed since beginPath().
        };

        function drawEverything()
        {
            // Clear the game view by filling it with black
            colorRect(0, 0, canvas.width, canvas.height, '#000000');

            // Draw left paddle.
            colorRect(0, paddle1Y, PADDLE_THICKNESS, PADDLE_HEIGHT, PADDLE_COLOR);

            // Draw right paddle.
            colorRect(canvas.width - PADDLE_THICKNESS, paddle2Y, PADDLE_THICKNESS, PADDLE_HEIGHT, PADDLE_COLOR);

            // Draw a white ball.
            colorCircle(ballX, ballY, 10, '#FFFFFF');

            canvasContext.fillText(paddle1Score, 100, 100);
            canvasContext.fillText(paddle2Score, canvas.width - 100, 100);
        };
    </script>
</html>